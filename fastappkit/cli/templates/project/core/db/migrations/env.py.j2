"""
Alembic environment configuration for core migrations.

This file configures Alembic to work with fastappkit's core migrations.
"""

import sys
from pathlib import Path
from logging.config import fileConfig

from alembic import context
from sqlalchemy import engine_from_config, pool

# Add project root to sys.path so core module can be imported
# This assumes env.py is in core/db/migrations/
_project_root = Path(__file__).parent.parent.parent.parent
if str(_project_root) not in sys.path:
    sys.path.insert(0, str(_project_root))

# Import your settings
from core.config import Settings  # noqa: E402
from sqlalchemy import MetaData  # noqa: E402

# Get settings
settings = Settings()
config = context.config

# Get target_metadata from config attributes (set by fastappkit autogenerate)
# or try to import from core models, or use empty MetaData
target_metadata = config.attributes.get("target_metadata")
if target_metadata is None:
    # Try to import metadata from core.models if available
    try:
        from core.models import Base
        target_metadata = Base.metadata
    except (ImportError, AttributeError):
        # No core models yet, use empty MetaData for initial migration
        target_metadata = MetaData()

# Get external app tables to exclude from autogenerate (set by fastappkit)
# This prevents core migrations from dropping external app tables
exclude_external_app_tables = config.attributes.get("exclude_external_app_tables", set())


def include_object(object, name, type_, reflected, compare_to):
    """
    Filter objects during autogenerate to exclude external app tables.

    This ensures core migrations don't try to drop tables that belong to external apps,
    which manage their own migrations independently.
    """
    if type_ == "table":
        # Exclude external app tables and version tables
        if name in exclude_external_app_tables:
            return False
        # Also exclude external app version tables (alembic_version_<appname>)
        if name.startswith("alembic_version_") and name != "alembic_version":
            return False
    return True

# Set database URL from settings
# Strip async drivers (e.g., +asyncpg, +aiosqlite) since Alembic doesn't support async
database_url = settings.database_url
# Remove common async driver suffixes
for async_driver in ["+asyncpg", "+aiosqlite", "+asyncmy"]:
    database_url = database_url.replace(async_driver, "")
config.set_main_option("sqlalchemy.url", database_url)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Other values from the config, defined by the needs of env.py
config.set_main_option("version_table", "alembic_version")


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        include_object=include_object,
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            include_object=include_object,
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
