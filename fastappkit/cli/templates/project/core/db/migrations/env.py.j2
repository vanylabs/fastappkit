"""
Alembic environment configuration for core migrations.

This file configures Alembic to work with fastappkit's core migrations.
"""

import sys
from pathlib import Path
from logging.config import fileConfig

from alembic import context
from sqlalchemy import engine_from_config, pool

# Add project root to sys.path so core module can be imported
# This assumes env.py is in core/db/migrations/
_project_root = Path(__file__).parent.parent.parent.parent
if str(_project_root) not in sys.path:
    sys.path.insert(0, str(_project_root))

# Import your settings
from core.config import Settings
from sqlalchemy import MetaData

# Get settings
settings = Settings()
config = context.config

# Get target_metadata from config attributes (set by fastappkit autogenerate)
# or try to import from core models, or use empty MetaData
target_metadata = config.attributes.get("target_metadata")
if target_metadata is None:
    # Try to import metadata from core.models if available
    try:
        from core.models import Base
        target_metadata = Base.metadata
    except (ImportError, AttributeError):
        # No core models yet, use empty MetaData for initial migration
        target_metadata = MetaData()

# Set database URL from settings
config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Other values from the config, defined by the needs of env.py
config.set_main_option("version_table", "alembic_version")


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
