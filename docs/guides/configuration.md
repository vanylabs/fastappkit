# Configuration

This guide covers configuring fastappkit projects and apps.

## Project Configuration

fastappkit uses `fastappkit.toml` for project configuration. This is separate from `pyproject.toml`.

### Basic Configuration

```toml
[tool.fastappkit]
apps = [
  "apps.blog",           # Internal app
  "apps.auth",           # Internal app
  "fastapi_payments",    # External app (pip-installed package)
]
```

### App Entry Formats

- `apps.<name>` → Internal app (located in `./apps/<name>/`)
- `<package_name>` → External app (pip-installed package, must be importable)

### Migration Order

You can override internal app order:

```toml
[tool.fastappkit.migration]
order = ["core", "auth", "blog"]
```

## Settings

Settings are defined in `core/config.py` using Pydantic's `BaseSettings`:

```python
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    """
    Application settings.

    Loads from .env file automatically.
    """

    DATABASE_URL: str = "sqlite:///./app.db"
    DEBUG: bool = False

    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8"
    )
```

### Extending Settings

The scaffolded code includes minimal settings. You can extend it by adding more fields:

```python
class Settings(BaseSettings):
    DATABASE_URL: str = "sqlite:///./app.db"
    DEBUG: bool = False

    # Add your custom settings here
    SECRET_KEY: str = "change-me-in-production"
    HOST: str = "127.0.0.1"
    PORT: int = 8000

    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=True,
        extra="ignore",  # Ignore extra fields from .env
    )
```

### Customization Options

- **Add Custom Settings:** Add fields to `Settings` class
- **Validation:** Use Pydantic validators: `@field_validator('DATABASE_URL')`
- **Default Values:** Set defaults in class definition
- **Nested Settings:** Use Pydantic models for nested configuration
- **Environment-Specific:** Override in `.env` or via environment variables

### Accessing Settings

**Runtime accessor (Django-like):**

```python
from fastappkit.conf import get_settings

settings = get_settings()
db_url = settings.DATABASE_URL
```

**FastAPI dependency injection:**

```python
from fastappkit.conf import get_settings
from fastapi import Depends
from core.config import Settings

def handler(settings: Settings = Depends(get_settings)):
    return settings.DEBUG
```

### Environment Variables

The `.env` file is auto-scaffolded and automatically loaded:

```bash
DATABASE_URL=sqlite:///./myproject.db
DEBUG=false
```

You can add additional environment variables as needed for your custom settings.

### Settings Initialization

Settings are initialized in `core/app.py` when the module is imported:

```python
# core/app.py (generated by fastappkit)
from core.config import Settings
from fastappkit.core.kit import FastAppKit

# Initialize FastAppKit with project's Settings
# This sets settings globally via set_settings() in FastAppKit.__init__
settings = Settings()  # Loads from .env automatically via BaseSettings
kit = FastAppKit(settings=settings)
app = kit.create_app()
```

The `Settings()` class automatically loads from `.env` via Pydantic's `BaseSettings`. When `FastAppKit` is initialized, it calls `set_settings()` which makes the settings globally available via `get_settings()`.

**For CLI/Migration Commands:**

CLI commands use `ensure_settings_loaded(project_root)` which imports `core.app`, causing the settings to be initialized automatically.

### FastAPI App Customization

You can customize the FastAPI app by modifying `core/app.py` or by subclassing `FastAppKit`:

**Option 1: Modify core/app.py directly**

```python
# core/app.py
from core.config import Settings
from fastappkit.core.kit import FastAppKit

settings = Settings()
kit = FastAppKit(settings=settings)
app = kit.create_app()

# Customize FastAPI app
app.title = "My Custom API"
app.version = "1.0.0"
app.description = "Custom API description"
```

**Option 2: Subclass FastAppKit**

```python
from fastappkit.core.kit import FastAppKit
from fastapi import FastAPI
from core.config import Settings

class CustomFastAppKit(FastAppKit):
    def create_app(self) -> FastAPI:
        app = super().create_app()
        # Add custom middleware, exception handlers, etc.
        app.add_middleware(...)
        app.title = "My Custom API"
        return app

settings = Settings()
kit = CustomFastAppKit(settings=settings)
app = kit.create_app()
```

## External App Manifest

External apps must declare metadata in `fastappkit.toml` located inside the package directory.

**Location:** `<app_name>/<app_name>/fastappkit.toml`

**Example:**

```toml
name = "blog"
version = "0.1.0"
entrypoint = "blog:register"
migrations = "migrations"
models_module = "blog.models"
route_prefix = "/blog"
```

!!! important "Manifest Requirements"
    The manifest file is `fastappkit.toml`, not `pyproject.toml`. It must be located in the package directory (where `__init__.py` is). This ensures it's included when the package is published to PyPI. No fallback - `fastappkit.toml` is required for external apps.

See the [Manifest Reference](../reference/manifest-reference.md) for complete details.

## Dependency Versions

!!! warning "Default Dependency Versions"
    When creating a new project or external app, dependency versions in `pyproject.toml` are set to `*` (any version) by default. This provides maximum flexibility but may lead to compatibility issues.

### Recommendations

**For Production Projects:**

- Update dependency versions to specific ranges (e.g., `>=0.120.0,<0.130`)
- Pin exact versions for critical dependencies
- Test thoroughly after updating versions

**For External Apps:**

- Match dependency versions with the core project for compatibility
- Use compatible version ranges that work with the core project's versions
- Document minimum required versions in your app's README

**Example:**

```toml
[tool.poetry.dependencies]
python = "^3.11"
fastapi = ">=0.120.0,<0.130"  # Specific range instead of *
sqlalchemy = ">=2.0,<3.0"
alembic = ">=1.17.2,<1.18"
```

!!! note "CLI Warning"
    The CLI will display a warning message when creating projects or external apps, reminding you to update dependency versions according to your needs.

## Learn More

- [Configuration Reference](../reference/configuration-reference.md) - Complete configuration options
- [Manifest Reference](../reference/manifest-reference.md) - External app manifest schema
